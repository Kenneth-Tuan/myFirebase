# 查詢系統功能使用指南

## 功能概述

新增了完整的查詢系統功能，支援多種查詢類型，包括今日行程、特定日期行程、群組列表和系統統計等。

## 支援的查詢類型

### 📅 今日行程查詢
**格式：**
```
查詢: 今日行程
```

**功能：** 查詢今日的所有行程安排

**回應範例：**
```
📅 2024年01月15日 的行程

共找到 3 個行程：

1. 團隊會議
   ⏰ 09:00 - 10:00
   📍 會議室A
   📝 討論本週工作進度...

2. 客戶拜訪
   ⏰ 14:00 - 15:30
   📍 台北市信義區

💡 點擊以下連結查看完整日曆：
https://calendar.google.com
```

### 📅 特定日期行程查詢
**格式：**
```
查詢: 日曆事件
日期: 2024-01-15
```

**功能：** 查詢指定日期的所有行程安排

**日期格式：** YYYY-MM-DD（例如：2024-01-15）

**回應範例：**
```
📅 2024年01月15日 的行程

共找到 2 個行程：

1. 週會
   ⏰ 14:00 - 15:00
   📝 每週例行會議

2. 健身時間
   ⏰ 18:00 - 19:00
   📍 健身房

💡 點擊以下連結查看完整日曆：
https://calendar.google.com
```

### 📋 群組列表查詢
**格式：**
```
查詢: 群組列表
```

**功能：** 查詢系統中的群組列表（開發中）

### 📊 系統統計查詢
**格式：**
```
查詢: 系統統計
```

**功能：** 查詢系統使用統計（開發中）

## 使用方法

### 在 LINE 中使用
1. 在 LINE 對話中發送查詢格式的訊息
2. 系統會自動解析並執行對應的查詢
3. 回傳格式化的查詢結果

### 查詢格式說明
- **查詢:** 必填，指定查詢類型
- **日期:** 可選，指定查詢日期（僅適用於日曆事件查詢）
- **參數:** 可選，額外查詢參數

## 技術實現

### 新增的檔案
- `functions/src/services/calendarService.js` - 新增 `getEventsByDate()` 方法
- `functions/src/handlers/lineWebhookHandler.js` - 新增查詢處理邏輯
- `functions/src/config/templates.js` - 更新查詢功能模板
- `functions/test-query-system.js` - 查詢系統測試檔案
- `functions/QUERY_SYSTEM_GUIDE.md` - 本說明文件

### 核心功能
1. **訊息解析**：解析查詢格式的訊息
2. **類型路由**：根據查詢類型路由到對應處理器
3. **日期處理**：支援今日和特定日期查詢
4. **錯誤處理**：完整的錯誤處理和用戶提示

### 查詢處理流程
```
用戶發送查詢訊息
    ↓
解析查詢格式
    ↓
驗證查詢類型
    ↓
路由到對應處理器
    ↓
執行查詢操作
    ↓
格式化回應
    ↓
回傳結果
```

## 測試方法

### 本地測試
```bash
cd functions
npm run test:query
```

### LINE 測試
1. 部署到 Firebase
2. 在 LINE 中發送查詢訊息
3. 檢查回應格式

## 部署步驟

1. **檢查配置**
   ```bash
   npm run config:check
   ```

2. **部署**
   ```bash
   npm run deploy
   ```

3. **驗證**
   - 在 LINE 中測試各種查詢功能
   - 檢查 Firebase Functions 日誌

## 錯誤處理

### 常見錯誤及解決方案

**查詢格式錯誤**
```
❌ 查詢格式錯誤，請使用正確的格式：
查詢: 查詢類型
日期: 日期（可選）
```

**不支援的查詢類型**
```
❌ 不支援的查詢類型：xxx

支援的查詢類型：
• 今日行程
• 日曆事件
• 群組列表
• 系統統計
```

**日期格式錯誤**
```
❌ 日期格式錯誤，請使用 YYYY-MM-DD 格式，例如：2024-01-15
```

**授權錯誤**
```
❌ 需要重新授權 Google Calendar，請先進行授權
```

## 向後兼容性

為了保持向後兼容性，以下舊格式仍然支援：

- `今日行程` - 等同於 `查詢: 今日行程`

## 未來擴展

### 短期改進
- [ ] 支援日期範圍查詢
- [ ] 支援多個日曆查詢
- [ ] 實作群組列表查詢
- [ ] 實作系統統計查詢

### 長期規劃
- [ ] 支援自然語言查詢
- [ ] 支援查詢結果快取
- [ ] 支援查詢歷史記錄
- [ ] 支援查詢結果匯出

## 故障排除

### 常見問題

**Q: 查詢沒有回應**
A: 檢查 Firebase Functions 是否正常運行，查看日誌確認錯誤

**Q: 日期查詢結果不正確**
A: 確認日期格式為 YYYY-MM-DD，檢查時區設定

**Q: 顯示授權錯誤**
A: 需要重新進行 Google Calendar 授權流程

### 日誌查看
```bash
firebase functions:log --only lineWebhook
```

## 更新記錄

- **2024-01-15**: 初始版本，支援基本查詢功能
- **2024-01-15**: 新增特定日期查詢功能
- **2024-01-15**: 整合到模板系統中 