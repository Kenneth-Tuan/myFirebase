# 今日行程查詢功能使用指南

## 功能概述

新增了查詢今日行程的功能，當用戶在 LINE 對話中發送"今日行程"時，系統會自動查詢 Google Calendar 中今日的所有行程並回傳到 LINE 對話中。

## 功能特點

### ✅ 自動查詢
- 發送"今日行程"即可自動查詢
- 無需複雜的指令格式
- 即時回傳結果

### 📅 完整資訊
- 顯示事件標題
- 顯示時間範圍（具體時間或全天）
- 顯示地點（如果有設定）
- 顯示描述摘要（限制50字元）
- 提供 Google Calendar 連結

### 🎨 美觀格式
- 使用表情符號增加可讀性
- 結構化顯示資訊
- 清晰的編號列表

### 🛡️ 錯誤處理
- 網路連線問題處理
- 授權過期處理
- 友善的錯誤訊息

## 使用方法

### 在 LINE 中查詢
1. 在 LINE 對話中發送：`今日行程`
2. 系統會自動查詢並回傳今日的所有行程
3. 如果沒有行程，會顯示休息提醒

### 回應格式範例

**有行程時：**
```
📅 2024年01月15日 的行程

共找到 3 個行程：

1. 團隊會議
   ⏰ 09:00 - 10:00
   📍 會議室A
   📝 討論本週工作進度...

2. 客戶拜訪
   ⏰ 14:00 - 15:30
   📍 台北市信義區

3. 健身時間
   ⏰ 18:00 - 19:00
   📍 健身房

💡 點擊以下連結查看完整日曆：
https://calendar.google.com
```

**無行程時：**
```
📅 2024年01月15日 的行程

🎉 今天沒有安排任何行程，可以好好休息！
```

## 技術實現

### 新增的檔案
- `functions/src/services/calendarService.js` - 新增 `getTodayEvents()` 方法
- `functions/src/handlers/lineWebhookHandler.js` - 新增 `handleTodayScheduleQuery()` 方法
- `functions/test-today-schedule.js` - 測試檔案
- `functions/TODAY_SCHEDULE_GUIDE.md` - 本說明文件

### 核心功能
1. **時間範圍計算**：使用 dayjs 計算今日的開始和結束時間
2. **API 查詢**：調用 Google Calendar API 獲取事件
3. **資料格式化**：將 API 回應格式化為易讀的格式
4. **錯誤處理**：處理各種可能的錯誤情況

### 測試方法
```bash
# 在 functions 目錄下執行
npm run test:today
```

## 部署步驟

1. **確保環境設定正確**
   ```bash
   npm run config:check
   ```

2. **部署到 Firebase**
   ```bash
   npm run deploy
   ```

3. **測試功能**
   - 在 LINE 中發送"今日行程"
   - 檢查回應是否正確

## 注意事項

### 權限要求
- 需要有效的 Google Calendar 授權
- 如果授權過期，會提示重新授權

### 限制
- 最多顯示 50 個今日事件
- 事件描述限制在 50 字元內
- 只查詢主要日曆（primary calendar）

### 錯誤處理
- 網路問題：提示稍後再試
- 授權問題：提示重新授權
- 其他錯誤：顯示一般錯誤訊息

## 未來改進

### 可能的擴展功能
- [ ] 支援查詢特定日期的行程
- [ ] 支援查詢多個日曆
- [ ] 支援更詳細的事件資訊
- [ ] 支援事件操作（編輯、刪除）
- [ ] 支援行程提醒功能

### 效能優化
- [ ] 實作快取機制
- [ ] 優化 API 呼叫頻率
- [ ] 實作分頁顯示

## 故障排除

### 常見問題

**Q: 發送"今日行程"沒有回應**
A: 檢查 Firebase Functions 是否正常運行，查看日誌確認錯誤

**Q: 顯示授權錯誤**
A: 需要重新進行 Google Calendar 授權流程

**Q: 查詢結果不正確**
A: 檢查 Google Calendar 中的事件設定，確認時區設定正確

### 日誌查看
```bash
firebase functions:log --only lineWebhook
```

## 更新記錄

- **2024-01-15**: 初始版本，支援基本今日行程查詢功能 