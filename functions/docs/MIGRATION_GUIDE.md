# é·ç§»æŒ‡å—ï¼šå¾èˆŠæ¶æ§‹åˆ°æ¨¡çµ„åŒ–æ¶æ§‹

## ğŸ“‹ è®Šæ›´æ¦‚è¿°

æœ¬æ¬¡é‡æ§‹å°‡åŸæœ¬å–®ä¸€çš„ `index.js` æ–‡ä»¶æ‹†åˆ†ç‚ºæ¨¡çµ„åŒ–çš„æ¶æ§‹ï¼Œæé«˜äº†ä»£ç¢¼çš„å¯ç¶­è­·æ€§å’Œå¯æ“´å±•æ€§ã€‚

## ğŸ”„ ä¸»è¦è®Šæ›´

### 1. æ–‡ä»¶çµæ§‹é‡çµ„

**èˆŠçµæ§‹ï¼š**

```
functions/
â”œâ”€â”€ index.js          # å–®ä¸€å…¥å£æ–‡ä»¶ï¼ˆ548è¡Œï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ ...
```

**æ–°çµæ§‹ï¼š**

```
functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ index.js          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ lineService.js    # LINE Bot æœå‹™
â”‚   â”‚   â”œâ”€â”€ calendarService.js # Google Calendar æœå‹™
â”‚   â”‚   â””â”€â”€ firestoreService.js # Firestore æœå‹™
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”œâ”€â”€ lineWebhookHandler.js # LINE Webhook è™•ç†
â”‚   â”‚   â”œâ”€â”€ broadcastHandler.js   # å»£æ’­åŠŸèƒ½è™•ç†
â”‚   â”‚   â””â”€â”€ statusHandler.js      # ç‹€æ…‹æª¢æŸ¥è™•ç†
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ errorHandler.js       # éŒ¯èª¤è™•ç†
â”‚   â”‚   â””â”€â”€ responseFormatter.js  # å›æ‡‰æ ¼å¼åŒ–
â”‚   â””â”€â”€ index.js              # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ index.js.backup           # èˆŠæ–‡ä»¶å‚™ä»½
â”œâ”€â”€ package.json
â””â”€â”€ ...
```

### 2. åŠŸèƒ½æ¨¡çµ„åŒ–

| èˆŠåŠŸèƒ½          | æ–°æ¨¡çµ„                           | èªªæ˜              |
| --------------- | -------------------------------- | ----------------- |
| LINE é…ç½®       | `config/index.js`                | é›†ä¸­ç®¡ç†ç’°å¢ƒè®Šæ•¸  |
| LINE Bot æ“ä½œ   | `services/lineService.js`        | LINE API ç›¸é—œæ“ä½œ |
| Google Calendar | `services/calendarService.js`    | æ—¥æ›†äº‹ä»¶ç®¡ç†      |
| Firestore æ“ä½œ  | `services/firestoreService.js`   | è³‡æ–™åº«æ“ä½œ        |
| Webhook è™•ç†    | `handlers/lineWebhookHandler.js` | LINE äº‹ä»¶è™•ç†     |
| å»£æ’­åŠŸèƒ½        | `handlers/broadcastHandler.js`   | ç¾¤çµ„å»£æ’­          |
| ç‹€æ…‹æª¢æŸ¥        | `handlers/statusHandler.js`      | ç³»çµ±ç›£æ§          |
| éŒ¯èª¤è™•ç†        | `utils/errorHandler.js`          | çµ±ä¸€éŒ¯èª¤è™•ç†      |
| å›æ‡‰æ ¼å¼åŒ–      | `utils/responseFormatter.js`     | çµ±ä¸€å›æ‡‰æ ¼å¼      |

### 3. æ–°å¢åŠŸèƒ½

- **å¥åº·æª¢æŸ¥ç«¯é»** (`/health`)
- **è©³ç´°çµ±è¨ˆç«¯é»** (`/stats`)
- **çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶**
- **çµæ§‹åŒ–çš„æ—¥èªŒè¨˜éŒ„**
- **æ›´å¥½çš„é…ç½®é©—è­‰**

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. å‚™ä»½ç•¶å‰ç‰ˆæœ¬

```bash
# èˆŠæ–‡ä»¶å·²è‡ªå‹•å‚™ä»½ç‚º index.js.backup
cd functions
ls -la index.js.backup  # ç¢ºèªå‚™ä»½å­˜åœ¨
```

### 2. æ›´æ–° package.json

```json
{
  "main": "src/index.js" // å·²æ›´æ–°
}
```

### 3. éƒ¨ç½²æ–°ç‰ˆæœ¬

```bash
npm run deploy
```

### 4. é©—è­‰åŠŸèƒ½

```bash
# æª¢æŸ¥ç‹€æ…‹
curl https://asia-east1-kenneth-project-a8d49.cloudfunctions.net/status

# æª¢æŸ¥å¥åº·ç‹€æ…‹
curl https://asia-east1-kenneth-project-a8d49.cloudfunctions.net/health

# æª¢æŸ¥è©³ç´°çµ±è¨ˆ
curl https://asia-east1-kenneth-project-a8d49.cloudfunctions.net/stats
```

## ğŸ”§ ç’°å¢ƒè®Šæ•¸

ç’°å¢ƒè®Šæ•¸ä¿æŒä¸è®Šï¼Œä½†ç¾åœ¨æœ‰æ›´å¥½çš„é©—è­‰æ©Ÿåˆ¶ï¼š

```bash
# å¿…è¦è®Šæ•¸
LINE_CHANNEL_SECRET=your_line_channel_secret
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token

# Google Calendarï¼ˆé¸æ“‡å…¶ä¸€ï¼‰
CALENDAR_API_KEY=your_google_calendar_api_key
# æˆ–
GOOGLE_CALENDAR_CREDENTIALS={"client_id":"...","client_secret":"...","redirect_uris":["..."]}
GOOGLE_CALENDAR_TOKEN={"access_token":"...","refresh_token":"..."}
```

## ğŸ“Š API ç«¯é»å°æ¯”

| åŠŸèƒ½         | èˆŠç«¯é»         | æ–°ç«¯é»         | è®Šæ›´        |
| ------------ | -------------- | -------------- | ----------- |
| LINE Webhook | `/lineWebhook` | `/lineWebhook` | âœ… ä¿æŒä¸è®Š |
| ç¾¤çµ„å»£æ’­     | `/broadcast`   | `/broadcast`   | âœ… ä¿æŒä¸è®Š |
| ç‹€æ…‹æª¢æŸ¥     | `/status`      | `/status`      | âœ… ä¿æŒä¸è®Š |
| å¥åº·æª¢æŸ¥     | âŒ ç„¡          | `/health`      | ğŸ†• æ–°å¢     |
| è©³ç´°çµ±è¨ˆ     | âŒ ç„¡          | `/stats`       | ğŸ†• æ–°å¢     |

## ğŸ” æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åŸºæœ¬åŠŸèƒ½æ¸¬è©¦

- [ ] LINE Webhook æ­£å¸¸æ¥æ”¶è¨Šæ¯
- [ ] ç¾¤çµ„å»£æ’­åŠŸèƒ½æ­£å¸¸
- [ ] æ—¥æ›†äº‹ä»¶å‰µå»ºæ­£å¸¸
- [ ] ç‹€æ…‹æª¢æŸ¥ç«¯é»æ­£å¸¸

### æ–°å¢åŠŸèƒ½æ¸¬è©¦

- [ ] å¥åº·æª¢æŸ¥ç«¯é» (`/health`)
- [ ] è©³ç´°çµ±è¨ˆç«¯é» (`/stats`)
- [ ] éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- [ ] æ—¥èªŒè¨˜éŒ„

### é…ç½®é©—è­‰

- [ ] ç’°å¢ƒè®Šæ•¸é©—è­‰
- [ ] LINE é…ç½®æª¢æŸ¥
- [ ] Google Calendar é…ç½®æª¢æŸ¥
- [ ] Firestore é€£æ¥æª¢æŸ¥

## ğŸš¨ å›æ»¾æ–¹æ¡ˆ

å¦‚æœæ–°ç‰ˆæœ¬å‡ºç¾å•é¡Œï¼Œå¯ä»¥å¿«é€Ÿå›æ»¾ï¼š

```bash
cd functions
mv index.js.backup index.js
npm run deploy
```

## ğŸ“ˆ æ€§èƒ½æ”¹é€²

### 1. ä»£ç¢¼çµ„ç¹”

- å–®ä¸€è·è²¬åŸå‰‡ï¼šæ¯å€‹æ¨¡çµ„åªè² è²¬ç‰¹å®šåŠŸèƒ½
- ä¾è³´æ³¨å…¥ï¼šæœå‹™ä¹‹é–“é¬†è€¦åˆ
- å¯æ¸¬è©¦æ€§ï¼šæ¯å€‹æ¨¡çµ„éƒ½å¯ä»¥ç¨ç«‹æ¸¬è©¦

### 2. éŒ¯èª¤è™•ç†

- çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- æ›´å¥½çš„éŒ¯èª¤åˆ†é¡å’Œæ—¥èªŒè¨˜éŒ„
- Webhook å®‰å…¨éŒ¯èª¤å›æ‡‰

### 3. ç›£æ§å’Œç¶­è­·

- è©³ç´°çš„ç³»çµ±çµ±è¨ˆ
- å¥åº·æª¢æŸ¥æ©Ÿåˆ¶
- çµæ§‹åŒ–çš„æ—¥èªŒæ ¼å¼

## ğŸ”® æœªä¾†æ“´å±•

æ–°çš„æ¨¡çµ„åŒ–æ¶æ§‹ç‚ºæœªä¾†åŠŸèƒ½æ“´å±•æä¾›äº†è‰¯å¥½çš„åŸºç¤ï¼š

### å®¹æ˜“æ·»åŠ çš„æ–°åŠŸèƒ½

- æ–°çš„ webhook è™•ç†å™¨
- æ–°çš„æœå‹™æ¨¡çµ„
- æ–°çš„å·¥å…·å‡½æ•¸
- æ–°çš„ API ç«¯é»

### å»ºè­°çš„ä¸‹ä¸€æ­¥

1. æ·»åŠ å–®å…ƒæ¸¬è©¦
2. å¯¦ç¾æ›´å¤š LINE åŠŸèƒ½
3. æ·»åŠ ç”¨æˆ¶ç®¡ç†
4. å¯¦ç¾æ›´è¤‡é›œçš„æ—¥æ›†åŠŸèƒ½
5. æ·»åŠ ç®¡ç†å¾Œå°

## ğŸ“ æ”¯æ´

å¦‚æœåœ¨é·ç§»éç¨‹ä¸­é‡åˆ°å•é¡Œï¼š

1. æª¢æŸ¥ Firebase Functions æ—¥èªŒ
2. ä½¿ç”¨å¥åº·æª¢æŸ¥ç«¯é»è¨ºæ–·å•é¡Œ
3. æŸ¥çœ‹è©³ç´°çµ±è¨ˆè³‡è¨Š
4. å¿…è¦æ™‚ä½¿ç”¨å›æ»¾æ–¹æ¡ˆ

## âœ… é·ç§»å®Œæˆæª¢æŸ¥

- [ ] æ–°æ¶æ§‹éƒ¨ç½²æˆåŠŸ
- [ ] æ‰€æœ‰ç«¯é»æ­£å¸¸é‹ä½œ
- [ ] åŠŸèƒ½æ¸¬è©¦é€šé
- [ ] æ—¥èªŒè¨˜éŒ„æ­£å¸¸
- [ ] æ€§èƒ½è¡¨ç¾è‰¯å¥½
- [ ] å‚™ä»½æ–‡ä»¶ä¿ç•™

---

**æ³¨æ„ï¼š** èˆŠçš„ `index.js.backup` æ–‡ä»¶å°‡ä¿ç•™ 30 å¤©ï¼Œä¹‹å¾Œå¯ä»¥å®‰å…¨åˆªé™¤ã€‚
